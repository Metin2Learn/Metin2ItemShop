<!DOCTYPE html>
<html lang="en">
  
<!-- Mirrored from docs.sura-head.dev/systems/itemshop/installation/server/game/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 03 Dec 2022 17:48:54 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.104.1">
    <meta name="generator" content="Relearn 5.2.3+tip">
    <meta name="description" content="">
    <title>Game :: sura_head.exe docs</title>
    <link href="index.xml" rel="alternate" type="application/rss+xml" title="sura_head.exe docs">
    <!-- https://github.com/filamentgroup/loadCSS/blob/master/README.md#how-to-use -->
    <link href="../../../../../css/fontawesome-all.min8069.css?1670088480" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../../css/fontawesome-all.min8069.css?1670088480" rel="stylesheet"></noscript>
    <link href="../../../../../css/featherlight.min8069.css?1670088480" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../../css/featherlight.min8069.css?1670088480" rel="stylesheet"></noscript>
    <link href="../../../../../css/auto-complete8069.css?1670088480" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../../css/auto-complete8069.css?1670088480" rel="stylesheet"></noscript>
    <link href="../../../../../css/perfect-scrollbar.min8069.css?1670088480" rel="stylesheet">
    <link href="../../../../../css/nucleus8069.css?1670088480" rel="stylesheet">
    <link href="../../../../../css/fonts8069.css?1670088480" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../../../css/fonts8069.css?1670088480" rel="stylesheet"></noscript>
    <link href="../../../../../css/theme8069.css?1670088480" rel="stylesheet">
    <link href="../../../../../css/theme-blue8069.css?1670088480" rel="stylesheet" id="variant-style">
    <link href="../../../../../css/ie8069.css?1670088480" rel="stylesheet">
    <link href="../../../../../css/variant8069.css?1670088480" rel="stylesheet">
    <link href="../../../../../css/print8069.css?1670088480" rel="stylesheet" media="print">
    <script src="../../../../../js/variant8069.js?1670088480"></script>
    <script>
      // hack to let hugo tell us how to get to the root when using relativeURLs, it needs to be called *url= for it to do its magic:
      // https://github.com/gohugoio/hugo/blob/145b3fcce35fbac25c7033c91c1b7ae6d1179da8/transform/urlreplacers/absurlreplacer.go#L72
      var index_url="../../../../../index.json";
      var root_url="../../../../../index.html";
      var baseUri=root_url.replace(/\/$/, '');
      // translations
      window.T_Copy_to_clipboard = 'Copy to clipboard';
      window.T_Copied_to_clipboard = 'Copied to clipboard!';
      window.T_Copy_link_to_clipboard = 'Copy link to clipboard';
      window.T_Link_copied_to_clipboard = 'Copied link to clipboard!';
      // some further base stuff
      var baseUriFull='index.html\/\/docs.sura-head.dev/';
      window.variants && variants.init( [ 'blue' ] );
    </script>
    <script src="../../../../../js/jquery.min8069.js?1670088480" defer></script><link id="dark-mode-theme" rel="stylesheet" href="../../../../../css/dark.css">
  </head>
  <body class="mobile-support html" data-url="/systems/itemshop/installation/server/game/">
    <div id="body" class="default-animation">
      <div id="sidebar-overlay"></div>
      <div id="toc-overlay"></div>
      <nav id="topbar" class="highlightable">
        <div>
          <div class="navigation">
             <a class="nav nav-next" href="../database/index.html" title="Database (&#129106;)"><i class="fas fa-chevron-right fa-fw"></i></a>
          </div>
          <div class="navigation">
             <a class="nav nav-prev" href="../db/index.html" title="DB (&#129104;)"><i class="fas fa-chevron-left fa-fw"></i></a>
          </div>
          <div id="breadcrumbs">
            <span id="sidebar-toggle-span">
              <a href="#" id="sidebar-toggle" title='Menu (CTRL+ALT+m)'><i class="fas fa-bars fa-fw"></i></a>
            </span>
            <span id="toc-menu" title='Table of Contents (CTRL+ALT+t)'><i class="fas fa-list-alt fa-fw"></i></span>
            <ol class="links" itemscope itemtype="http://schema.org/BreadcrumbList">
              <meta itemprop="itemListOrder" content="Descending" />
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><meta itemprop="position" content="6" /><a itemprop="item" href="../../../../../index.html"><span itemprop="name">docs.sura-head.dev</span></a> > </li>
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><meta itemprop="position" content="5" /><a itemprop="item" href="../../../../index.html"><span itemprop="name">Systems</span></a> > </li>
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><meta itemprop="position" content="4" /><a itemprop="item" href="../../../index.html"><span itemprop="name">Itemshop</span></a> > </li>
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><meta itemprop="position" content="3" /><a itemprop="item" href="../../index.html"><span itemprop="name">Installation</span></a> > </li>
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><meta itemprop="position" content="2" /><a itemprop="item" href="../index.html"><span itemprop="name">Server</span></a> > </li>
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><meta itemprop="position" content="1" /><a itemprop="item" href="index.html" aria-disabled="true"><span itemprop="name">Game</span></a></li>
            </ol>
          </div>
          <div class="default-animation progress">
            <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-charcpp">1. char.cpp</a></li>
        <li><a href="#2-charh">2. char.h</a></li>
        <li><a href="#3-character_managercpp">3. character_manager.cpp</a></li>
        <li><a href="#4-character_managercpp">4. character_manager.cpp</a></li>
        <li><a href="#5-cmd_gmcpp">5. cmd_gm.cpp</a></li>
        <li><a href="#6-inputh">6. input.h</a></li>
        <li><a href="#7-input_dbcpp">7. input_db.cpp</a></li>
        <li><a href="#8-input_logincpp">8. input_login.cpp</a></li>
        <li><a href="#9-input_maincpp">9. input_main.cpp</a></li>
        <li><a href="#10-maincpp">10. main.cpp</a></li>
        <li><a href="#11-packeth">11. packet.h</a></li>
        <li><a href="#12-packet_infocpp">12. packet_info.cpp</a></li>
        <li><a href="#13-makefile--solution">13. MakeFile / Solution</a></li>
        <li><a href="#14-itemshoph">14. itemshop.h</a></li>
        <li><a href="#15-itemshopcpp">15. itemshop.cpp</a></li>
      </ul>
    </li>
  </ul>
</nav>
            </div>
          </div>
        </div>
      </nav>
      <main id="body-inner" class="highlightable default" tabindex="-1">
        <div class="flex-block-wrapper">
          <div id="head-tags">
          </div>
          <article class="default">
<h1>Game</h1>

<h3 id="1-charcpp">1. char.cpp</h3>
<p>Add:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&#34;itemshop.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#endif
</span></span></span></code></pre></div><hr>
<p>Search:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CHARACTER</span><span class="o">::</span><span class="n">Initialize</span><span class="p">()</span>
</span></span></code></pre></div><p>Add to the end of this function:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="n">m_iItemshopCooldownTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">m_iPromotionCodeCooldownTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><hr>
<p>Add to end of file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="kt">void</span> <span class="n">CHARACTER</span><span class="o">::</span><span class="n">SendPromotionRewardPacket</span><span class="p">(</span><span class="n">BYTE</span> <span class="n">byAnswer</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TPromotionItemTable</span><span class="o">&gt;</span> <span class="n">items</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">TEMP_BUFFER</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">TPacketGCItemshopInfo</span> <span class="n">itemshop_info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">itemshop_info</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">HEADER_GC_ITEMSHOP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">itemshop_info</span><span class="p">.</span><span class="n">subheader</span> <span class="o">=</span> <span class="n">SUBHEADER_PROMOTION_CODE_REWARDS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itemshop_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TPacketGCItemshopInfo</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">byAnswer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BYTE</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">items</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">size_t</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">items</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TPromotionItemTable</span><span class="p">)</span> <span class="o">*</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">GetDesc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Packet</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">read_peek</span><span class="p">(),</span> <span class="n">buf</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CHARACTER</span><span class="o">::</span><span class="n">SendItemshopSingleItemRefreshPacket</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">TEMP_BUFFER</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">TPacketGCItemshopInfo</span> <span class="n">itemshop_info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">itemshop_info</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">HEADER_GC_ITEMSHOP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">itemshop_info</span><span class="p">.</span><span class="n">subheader</span> <span class="o">=</span> <span class="n">SUBHEADER_ITEMSHOP_REFRESH_SINGLE_ITEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itemshop_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TPacketGCItemshopInfo</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">GetDesc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Packet</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">read_peek</span><span class="p">(),</span> <span class="n">buf</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CHARACTER</span><span class="o">::</span><span class="n">SendItemshopSingleItemRemovePacket</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">TEMP_BUFFER</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">TPacketGCItemshopInfo</span> <span class="n">itemshop_info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">itemshop_info</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">HEADER_GC_ITEMSHOP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">itemshop_info</span><span class="p">.</span><span class="n">subheader</span> <span class="o">=</span> <span class="n">SUBHEADER_ITEMSHOP_REMOVE_SINGLE_ITEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itemshop_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TPacketGCItemshopInfo</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">GetDesc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Packet</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">read_peek</span><span class="p">(),</span> <span class="n">buf</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CHARACTER</span><span class="o">::</span><span class="n">SendItemshopSingleItemAddPacket</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">,</span> <span class="n">TItemshopCategoryInfo</span> <span class="n">category</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">TEMP_BUFFER</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">TPacketGCItemshopInfo</span> <span class="n">itemshop_info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">itemshop_info</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">HEADER_GC_ITEMSHOP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">itemshop_info</span><span class="p">.</span><span class="n">subheader</span> <span class="o">=</span> <span class="n">SUBHEADER_ITEMSHOP_ADD_SINGLE_ITEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itemshop_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TPacketGCItemshopInfo</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">category</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TItemshopCategoryInfo</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">GetDesc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Packet</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">read_peek</span><span class="p">(),</span> <span class="n">buf</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CHARACTER</span><span class="o">::</span><span class="n">SendItemshopItemsPacket</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span> <span class="o">&lt;</span><span class="n">BYTE</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TItemshopItemTable</span><span class="o">&gt;&gt;</span> <span class="n">items</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span> <span class="o">&lt;</span><span class="n">BYTE</span><span class="p">,</span> <span class="n">TItemshopCategoryInfo</span><span class="o">&gt;</span> <span class="n">categories</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SendItemshopCoinPacket</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">TEMP_BUFFER</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">TPacketGCItemshopInfo</span> <span class="n">itemshop_info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">itemshop_info</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">HEADER_GC_ITEMSHOP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">itemshop_info</span><span class="p">.</span><span class="n">subheader</span> <span class="o">=</span> <span class="n">SUBHEADER_ITEMSHOP_REFRESH_ITEMS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itemshop_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TPacketGCItemshopInfo</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">TPacketGCitemshopCategorySize</span> <span class="n">itemshop_categorie_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">itemshop_categorie_size</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">categories</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itemshop_categorie_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TPacketGCitemshopCategorySize</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">]</span> <span class="o">:</span> <span class="n">categories</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BYTE</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TItemshopCategoryInfo</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">TPacketGCItemshopItemSize</span> <span class="n">itemshop_item_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">itemshop_item_size</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">items</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itemshop_item_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TPacketGCItemshopItemSize</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">size_t</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">vec</span><span class="p">]</span> <span class="o">:</span> <span class="n">items</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BYTE</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="n">temp</span> <span class="o">=</span> <span class="n">vec</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">temp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">size_t</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">vec</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="p">)</span> <span class="o">*</span> <span class="n">temp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">GetDesc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Packet</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">read_peek</span><span class="p">(),</span> <span class="n">buf</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CHARACTER</span><span class="o">::</span><span class="n">SendItemshopCoinPacket</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">TAccountTable</span><span class="o">&amp;</span> <span class="n">accTable</span> <span class="o">=</span> <span class="n">GetDesc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetAccountTable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ulltotalCoins</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SQLMsg</span><span class="o">&gt;</span> <span class="n">pkMsg</span><span class="p">(</span><span class="n">DBManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">DirectQuery</span><span class="p">(</span><span class="s">&#34;SELECT coins from account.account WHERE id = %ld&#34;</span><span class="p">,</span> <span class="n">accTable</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">SQLResult</span><span class="o">*</span> <span class="n">pRes</span> <span class="o">=</span> <span class="n">pkMsg</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">pRes</span><span class="o">-&gt;</span><span class="n">uiNumRows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">MYSQL_ROW</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mysql_fetch_row</span><span class="p">(</span><span class="n">pRes</span><span class="o">-&gt;</span><span class="n">pSQLResult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">str_to_number</span><span class="p">(</span><span class="n">ulltotalCoins</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">TEMP_BUFFER</span> <span class="n">buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">TPacketGCItemshopInfo</span> <span class="n">itemshop_info</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">itemshop_info</span><span class="p">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">HEADER_GC_ITEMSHOP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">itemshop_info</span><span class="p">.</span><span class="n">subheader</span> <span class="o">=</span> <span class="n">SUBHEADER_ITEMSHOP_REFRESH_COINS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itemshop_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TPacketGCItemshopInfo</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">buf</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ulltotalCoins</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">GetDesc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Packet</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">read_peek</span><span class="p">(),</span> <span class="n">buf</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><hr>
<h3 id="2-charh">2. char.h</h3>
<p>Add to end of <strong>class CHARACTER</strong> :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">			<span class="kt">void</span>	<span class="n">SendItemshopItemsPacket</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">				<span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span> <span class="o">&lt;</span><span class="n">BYTE</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TItemshopItemTable</span><span class="o">&gt;&gt;</span> <span class="n">items</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span> <span class="o">&lt;</span><span class="n">BYTE</span><span class="p">,</span> <span class="n">TItemshopCategoryInfo</span><span class="o">&gt;</span> <span class="n">categories</span>
</span></span><span class="line"><span class="cl">			<span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="kt">void</span>	<span class="nf">SendPromotionRewardPacket</span><span class="p">(</span><span class="n">BYTE</span> <span class="n">byAnswer</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TPromotionItemTable</span><span class="o">&gt;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="kt">void</span>	<span class="nf">SendItemshopSingleItemRefreshPacket</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="kt">void</span>	<span class="nf">SendItemshopSingleItemRemovePacket</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="kt">void</span>	<span class="nf">SendItemshopSingleItemAddPacket</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">,</span> <span class="n">TItemshopCategoryInfo</span> <span class="n">category</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="kt">void</span>	<span class="nf">SendItemshopCoinPacket</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="kt">bool</span>	<span class="nf">CanUseItemshop</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span>  <span class="n">m_iItemshopCooldownTime</span> <span class="o">&lt;</span> <span class="n">thecore_pulse</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="kt">void</span>	<span class="nf">SetItemshopCooldown</span><span class="p">(</span><span class="kt">int</span> <span class="n">pulse</span><span class="p">)</span> <span class="p">{</span> <span class="n">m_iItemshopCooldownTime</span> <span class="o">=</span> <span class="n">pulse</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="kt">bool</span>	<span class="nf">CanUsePromotionCode</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span>  <span class="n">m_iPromotionCodeCooldownTime</span> <span class="o">&lt;</span> <span class="n">thecore_pulse</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="kt">void</span>	<span class="nf">SetPromotionCodedown</span><span class="p">(</span><span class="kt">int</span> <span class="n">pulse</span><span class="p">)</span> <span class="p">{</span> <span class="n">m_iPromotionCodeCooldownTime</span> <span class="o">=</span> <span class="n">pulse</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">			<span class="kt">int</span>		<span class="n">m_iItemshopCooldownTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="kt">int</span>		<span class="n">m_iPromotionCodeCooldownTime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><hr>
<h3 id="3-character_managercpp">3. character_manager.cpp</h3>
<p>Add:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&#34;itemshop.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#endif
</span></span></span></code></pre></div><p>Add to end of file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="kt">void</span> <span class="n">CHARACTER_MANAGER</span><span class="o">::</span><span class="n">SendItemshopSingleRemoveItem</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span><span class="n">player_id</span><span class="p">,</span> <span class="n">ch</span><span class="p">]</span> <span class="o">:</span> <span class="n">m_map_pkChrByPID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">SendItemshopSingleItemRemovePacket</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CHARACTER_MANAGER</span><span class="o">::</span><span class="n">SendItemshopSingleAddItem</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">categories</span> <span class="o">=</span> <span class="n">CItemshopManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">GetItemshopCategories</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">category_info</span> <span class="o">=</span> <span class="n">categories</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">byCategory</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">category_info</span> <span class="o">==</span> <span class="n">categories</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// This could NEVER happen but it seems like it does
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span><span class="n">player_id</span><span class="p">,</span> <span class="n">ch</span><span class="p">]</span> <span class="o">:</span> <span class="n">m_map_pkChrByPID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">SendItemshopSingleItemAddPacket</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">category_info</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CHARACTER_MANAGER</span><span class="o">::</span><span class="n">SendItemshopSingleItemRefresh</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span><span class="n">player_id</span><span class="p">,</span> <span class="n">ch</span><span class="p">]</span> <span class="o">:</span> <span class="n">m_map_pkChrByPID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">SendItemshopSingleItemRefreshPacket</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CHARACTER_MANAGER</span><span class="o">::</span><span class="n">SendItemshopItems</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">items</span> <span class="o">=</span> <span class="n">CItemshopManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">GetItemshopItems</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">categories</span> <span class="o">=</span> <span class="n">CItemshopManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">GetItemshopCategories</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span><span class="n">player_id</span><span class="p">,</span> <span class="n">ch</span><span class="p">]</span> <span class="o">:</span> <span class="n">m_map_pkChrByPID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">SendItemshopItemsPacket</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">categories</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><hr>
<h3 id="4-character_managercpp">4. character_manager.cpp</h3>
<p>Add to end of <strong>class CHARACTER_MANAGER</strong>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">			<span class="kt">void</span>			<span class="n">SendItemshopSingleRemoveItem</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="kt">void</span>			<span class="nf">SendItemshopSingleAddItem</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="kt">void</span>			<span class="nf">SendItemshopSingleItemRefresh</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="kt">void</span>			<span class="nf">SendItemshopItems</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><hr>
<h3 id="5-cmd_gmcpp">5. cmd_gm.cpp</h3>
<p>Search:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">				<span class="k">case</span> <span class="sc">&#39;p&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">					<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ChatPacket</span><span class="p">(</span><span class="n">CHAT_TYPE_INFO</span><span class="p">,</span> <span class="s">&#34;Reloading prototype tables,&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="n">db_clientdesc</span><span class="o">-&gt;</span><span class="n">DBPacket</span><span class="p">(</span><span class="n">HEADER_GD_RELOAD_PROTO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="k">break</span><span class="p">;</span>
</span></span></code></pre></div><p>Add:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>				<span class="k">case</span> <span class="sc">&#39;i&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">					<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ChatPacket</span><span class="p">(</span><span class="n">CHAT_TYPE_INFO</span><span class="p">,</span> <span class="s">&#34;Reloading itemshop tables,&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="n">db_clientdesc</span><span class="o">-&gt;</span><span class="n">DBPacket</span><span class="p">(</span><span class="n">HEADER_GD_RELOAD_ITEMSHOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><hr>
<h3 id="6-inputh">6. input.h</h3>
<p>Search:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">			<span class="kt">void</span>		<span class="nf">Refine</span><span class="p">(</span><span class="n">LPCHARACTER</span> <span class="n">ch</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">c_pData</span><span class="p">);</span>
</span></span></code></pre></div><p>Add:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>			<span class="kt">void</span>		<span class="nf">BuyItemshopItem</span><span class="p">(</span><span class="n">LPCHARACTER</span> <span class="n">ch</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">c_pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="kt">void</span>		<span class="nf">RedeemPromotionCode</span><span class="p">(</span><span class="n">LPCHARACTER</span> <span class="n">ch</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">c_pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><p>Search:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">		<span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">DWORD</span>		<span class="n">m_dwHandle</span><span class="p">;</span>
</span></span></code></pre></div><p>Add:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="k">protected</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">			<span class="kt">void</span>	<span class="n">ReloadItemshop</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">c_pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="kt">void</span>	<span class="nf">ItemshopBuyAnswer</span><span class="p">(</span><span class="n">LPDESC</span> <span class="n">d</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">c_pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="kt">void</span>	<span class="nf">RedeemPromotionCode</span><span class="p">(</span><span class="n">LPDESC</span> <span class="n">d</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">c_pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><hr>
<h3 id="7-input_dbcpp">7. input_db.cpp</h3>
<p>Add:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&#34;itemshop.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#endif
</span></span></span></code></pre></div><p>Search:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">decode_2bytes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TRefineTable</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">sys_err</span><span class="p">(</span><span class="s">&#34;refine table size error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">thecore_shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">size</span> <span class="o">=</span> <span class="n">decode_2bytes</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">sys_log</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#34;BOOT: REFINE: %d&#34;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">CRefineManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">Initialize</span><span class="p">((</span><span class="n">TRefineTable</span><span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">data</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TRefineTable</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span></code></pre></div><p>Add:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">decode_2bytes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TItemshopCategoryTable</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">sys_err</span><span class="p">(</span><span class="s">&#34;itemshop table category size error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">thecore_shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">size</span> <span class="o">=</span> <span class="n">decode_2bytes</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">sys_log</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#34;BOOT: ITEMSHOP: %d&#34;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">CItemshopManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">InitializeCategories</span><span class="p">((</span><span class="n">TItemshopCategoryTable</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">data</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TItemshopCategoryTable</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">decode_2bytes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">sys_err</span><span class="p">(</span><span class="s">&#34;itemshop item table size error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">thecore_shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">size</span> <span class="o">=</span> <span class="n">decode_2bytes</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">sys_log</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#34;BOOT: ITEMSHOP: %d&#34;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">CItemshopManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">InitializeItems</span><span class="p">((</span><span class="n">TItemshopItemTable</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">data</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><p>Search:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">HEADER_DG_RELOAD_PROTO</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">ReloadProto</span><span class="p">(</span><span class="n">c_pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span></code></pre></div><p>Add:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="k">case</span> <span class="nl">HEADER_DG_RELOAD_ITEMSHOP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">ReloadItemshop</span><span class="p">(</span><span class="n">c_pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">HEADER_DG_REFRESH_ITEMSHOP_SINGLE_ITEM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">CItemshopManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">RefreshSingleItem</span><span class="p">((</span><span class="n">TItemshopItemTable</span><span class="o">*</span><span class="p">)</span><span class="n">c_pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">HEADER_DG_REMOVE_ITEMSHOP_SINGLE_ITEM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">CItemshopManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">RemoveSingleItem</span><span class="p">((</span><span class="n">TItemshopItemTable</span><span class="o">*</span><span class="p">)</span><span class="n">c_pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">HEADER_DG_ADD_ITEMSHOP_SINGLE_ITEM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">CItemshopManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">AddSingleItem</span><span class="p">((</span><span class="n">TItemshopItemTable</span><span class="o">*</span><span class="p">)</span><span class="n">c_pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">HEADER_DG_BUY_ITEMSHOP_ITEM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">ItemshopBuyAnswer</span><span class="p">(</span><span class="n">DESC_MANAGER</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">FindByHandle</span><span class="p">(</span><span class="n">m_dwHandle</span><span class="p">),</span> <span class="n">c_pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nl">HEADER_DG_PROMOTION_CODE_REDEEM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="n">RedeemPromotionCode</span><span class="p">(</span><span class="n">DESC_MANAGER</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">FindByHandle</span><span class="p">(</span><span class="n">m_dwHandle</span><span class="p">),</span> <span class="n">c_pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><p>Add to end of file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="kt">void</span> <span class="n">CInputDB</span><span class="o">::</span><span class="n">ItemshopBuyAnswer</span><span class="p">(</span><span class="n">LPDESC</span> <span class="n">d</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">c_pData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">GetCharacter</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">TItemshopBuyAnswer</span><span class="o">*</span> <span class="n">buy_answer</span> <span class="o">=</span> <span class="p">(</span><span class="n">TItemshopBuyAnswer</span><span class="o">*</span><span class="p">)</span><span class="n">c_pData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LPCHARACTER</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">GetCharacter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">buy_answer</span><span class="o">-&gt;</span><span class="n">canBuy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">CItemshopManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">BuyItem</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">buy_answer</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">buy_answer</span><span class="o">-&gt;</span><span class="n">wCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ChatPacket</span><span class="p">(</span><span class="n">CHAT_TYPE_INFO</span><span class="p">,</span> <span class="s">&#34;cannot buy&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CInputDB</span><span class="o">::</span><span class="n">RedeemPromotionCode</span><span class="p">(</span><span class="n">LPDESC</span> <span class="n">d</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">c_pData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">GetCharacter</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">TPromotionRedeemAnswer</span><span class="o">*</span> <span class="n">redeem_answer</span> <span class="o">=</span> <span class="p">(</span><span class="n">TPromotionRedeemAnswer</span><span class="o">*</span><span class="p">)</span><span class="n">c_pData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LPCHARACTER</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">GetCharacter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">std</span><span class="o">::</span><span class="n">vector</span> <span class="o">&lt;</span><span class="n">TPromotionItemTable</span><span class="o">&gt;</span> <span class="n">itemsGiven</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">redeem_answer</span><span class="o">-&gt;</span><span class="n">byRedeemAnswer</span> <span class="o">==</span> <span class="n">REDEEM_SUCCESS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">TPromotionItemTable</span><span class="o">*</span> <span class="n">rewards</span> <span class="o">=</span> <span class="p">(</span><span class="n">TPromotionItemTable</span><span class="o">*</span><span class="p">)(</span><span class="n">c_pData</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TPromotionRedeemAnswer</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">redeem_answer</span><span class="o">-&gt;</span><span class="n">reward_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">rewards</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">const</span> <span class="n">TItemTable</span><span class="o">*</span> <span class="n">item_table</span> <span class="o">=</span> <span class="n">ITEM_MANAGER</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">GetTable</span><span class="p">(</span><span class="n">rewards</span><span class="o">-&gt;</span><span class="n">dwVnum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="n">item_table</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// NOTE: Stupid admin i guess
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="k">if</span> <span class="p">(</span><span class="n">rewards</span><span class="o">-&gt;</span><span class="n">wCount</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">IS_SET</span><span class="p">(</span><span class="n">item_table</span><span class="o">-&gt;</span><span class="n">dwAntiFlags</span><span class="p">,</span> <span class="n">ITEM_ANTIFLAG_STACK</span><span class="p">))</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">IS_SET</span><span class="p">(</span><span class="n">item_table</span><span class="o">-&gt;</span><span class="n">dwFlags</span><span class="p">,</span> <span class="n">ITEM_FLAG_STACKABLE</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">						<span class="n">rewards</span><span class="o">-&gt;</span><span class="n">wCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="n">LPITEM</span> <span class="n">item</span> <span class="o">=</span> <span class="n">ITEM_MANAGER</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">CreateItem</span><span class="p">(</span><span class="n">rewards</span><span class="o">-&gt;</span><span class="n">dwVnum</span><span class="p">,</span> <span class="n">rewards</span><span class="o">-&gt;</span><span class="n">wCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ChatPacket</span><span class="p">(</span><span class="n">CHAT_TYPE_INFO</span><span class="p">,</span> <span class="s">&#34;item does not exist, contact SA for free coins :)&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="kt">bool</span> <span class="n">forcedSockets</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="n">rewards</span><span class="o">-&gt;</span><span class="n">alSockets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ITEM_LIMIT_MAX_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="k">if</span> <span class="p">(</span><span class="n">LIMIT_REAL_TIME</span> <span class="o">==</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">GetLimitType</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">						<span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="c1">// NOTE: We set socket0 as time value, but only if socket is set so we still can use default times in createitem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>							<span class="n">item</span><span class="o">-&gt;</span><span class="n">SetSocket</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">rewards</span><span class="o">-&gt;</span><span class="n">alSockets</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">							<span class="c1">// NOTE: We dont have to start realtime event because createitem does
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>							<span class="n">forcedSockets</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">						<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">LIMIT_TIMER_BASED_ON_WEAR</span> <span class="o">==</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">GetLimitType</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">						<span class="p">{</span>
</span></span><span class="line"><span class="cl">							<span class="c1">// NOTE: We force socket0 if set
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>							<span class="n">item</span><span class="o">-&gt;</span><span class="n">SetSocket</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rewards</span><span class="o">-&gt;</span><span class="n">alSockets</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">							<span class="n">forcedSockets</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">						<span class="p">}</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="c1">// NOTE: I dont have systems where i need to set multible sockets in createitem but you can still do:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">				for(const auto&amp; socket : itemInfo.alSockets){
</span></span></span><span class="line"><span class="cl"><span class="cm">					if (socket)
</span></span></span><span class="line"><span class="cl"><span class="cm">					{
</span></span></span><span class="line"><span class="cl"><span class="cm">						Funny socket method here
</span></span></span><span class="line"><span class="cl"><span class="cm">					}
</span></span></span><span class="line"><span class="cl"><span class="cm">				}
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">				*/</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">forcedSockets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="n">item</span><span class="o">-&gt;</span><span class="n">SetSockets</span><span class="p">(</span><span class="n">rewards</span><span class="o">-&gt;</span><span class="n">alSockets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="c1">// NOTE: You can adjust this if you want to use bAlterToMagicItemPct
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">item</span><span class="o">-&gt;</span><span class="n">SetAttributes</span><span class="p">(</span><span class="n">rewards</span><span class="o">-&gt;</span><span class="n">aAttr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">AutoGiveItem</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="n">itemsGiven</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">*</span><span class="n">rewards</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">SendPromotionRewardPacket</span><span class="p">(</span><span class="n">redeem_answer</span><span class="o">-&gt;</span><span class="n">byRedeemAnswer</span><span class="p">,</span> <span class="n">itemsGiven</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CInputDB</span><span class="o">::</span><span class="n">ReloadItemshop</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">c_pData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">WORD</span><span class="o">*</span> <span class="n">category_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="o">*</span><span class="p">)</span><span class="n">c_pData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">c_pData</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WORD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">WORD</span><span class="o">*</span> <span class="n">item_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">WORD</span><span class="o">*</span><span class="p">)</span><span class="n">c_pData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">c_pData</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">WORD</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">CItemshopManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">InitializeCategories</span><span class="p">((</span><span class="n">TItemshopCategoryTable</span><span class="o">*</span><span class="p">)</span><span class="n">c_pData</span><span class="p">,</span> <span class="o">*</span><span class="n">category_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">c_pData</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TItemshopCategoryTable</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">category_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">CItemshopManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">InitializeItems</span><span class="p">((</span><span class="n">TItemshopItemTable</span><span class="o">*</span><span class="p">)</span><span class="n">c_pData</span><span class="p">,</span> <span class="o">*</span><span class="n">item_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">c_pData</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">item_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">CHARACTER_MANAGER</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">SendItemshopItems</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><hr>
<h3 id="8-input_logincpp">8. input_login.cpp</h3>
<p>Add:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&#34;itemshop.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#endif
</span></span></span></code></pre></div><p>Search:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CInputLogin</span><span class="o">::</span><span class="n">Entergame</span><span class="p">(</span><span class="n">LPDESC</span> <span class="n">d</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span><span class="p">)</span>
</span></span></code></pre></div><p>Add to end of this function:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">SendItemshopItemsPacket</span><span class="p">(</span><span class="n">CItemshopManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">GetItemshopItems</span><span class="p">(),</span> <span class="n">CItemshopManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">GetItemshopCategories</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><hr>
<h3 id="9-input_maincpp">9. input_main.cpp</h3>
<p>Add:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&#34;itemshop.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#endif
</span></span></span></code></pre></div><p>Search:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">HEADER_CG_ACCE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">((</span><span class="n">iExtraLen</span> <span class="o">=</span> <span class="n">AcceRefine</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">c_pData</span><span class="p">,</span> <span class="n">m_iBufferLeft</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span></code></pre></div><p>Add:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>			<span class="k">case</span> <span class="nl">HEADER_CG_BUY_ITEMSHOP_ITEM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">BuyItemshopItem</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">c_pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">case</span> <span class="nl">HEADER_CG_PROMOTION</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">RedeemPromotionCode</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">c_pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><p>Add to end of file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="kt">void</span> <span class="n">CInputMain</span><span class="o">::</span><span class="n">BuyItemshopItem</span><span class="p">(</span><span class="n">LPCHARACTER</span> <span class="n">ch</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">c_pData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">TPacketCGBuyItemshopItem</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">TPacketCGBuyItemshopItem</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">c_pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">CItemshopManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">CanBuyItem</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">wCount</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">TItemshopCheckBuy</span> <span class="n">p_gd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">strlcpy</span><span class="p">(</span><span class="n">p_gd</span><span class="p">.</span><span class="n">hash</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p_gd</span><span class="p">.</span><span class="n">hash</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="n">p_gd</span><span class="p">.</span><span class="n">wCount</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">wCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">db_clientdesc</span><span class="o">-&gt;</span><span class="n">DBPacket</span><span class="p">(</span><span class="n">HEADER_GD_BUY_ITEMSHOP</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">GetDesc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetHandle</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">p_gd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p_gd</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CInputMain</span><span class="o">::</span><span class="n">RedeemPromotionCode</span><span class="p">(</span><span class="n">LPCHARACTER</span> <span class="n">ch</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">c_pData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">CanUsePromotionCode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ChatPacket</span><span class="p">(</span><span class="n">CHAT_TYPE_INFO</span><span class="p">,</span> <span class="n">LC_TEXT</span><span class="p">(</span><span class="s">&#34;You have to wait 10 seconds after using promotion codes.&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">SetPromotionCodedown</span><span class="p">(</span><span class="n">thecore_pulse</span><span class="p">()</span> <span class="o">+</span> <span class="n">PASSES_PER_SEC</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">TPacketCGRedeemPromotionCode</span><span class="o">*</span> <span class="n">p</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">TPacketCGRedeemPromotionCode</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">c_pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// We dont have to check but atleast we dont send gd -&gt; dg -&gt; gc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">promotion_code</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">TPromotionRedeem</span> <span class="n">gd_p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">strlcpy</span><span class="p">(</span><span class="n">gd_p</span><span class="p">.</span><span class="n">code</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">promotion_code</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gd_p</span><span class="p">.</span><span class="n">code</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">gd_p</span><span class="p">.</span><span class="n">accID</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">GetAID</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">db_clientdesc</span><span class="o">-&gt;</span><span class="n">DBPacket</span><span class="p">(</span><span class="n">HEADER_GD_PROMOTION_REDEEM</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">GetDesc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetHandle</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">gd_p</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gd_p</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><hr>
<h3 id="10-maincpp">10. main.cpp</h3>
<p>Add:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&#34;itemshop.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#endif
</span></span></span></code></pre></div><p>Search:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">CRefineManager</span>	<span class="n">refine_manager</span><span class="p">;</span>
</span></span></code></pre></div><p>Add:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="n">CItemshopManager</span> <span class="n">itemshop_manager</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><hr>
<h3 id="11-packeth">11. packet.h</h3>
<p>Search:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">		<span class="n">HEADER_GC_TIME_SYNC</span>							<span class="o">=</span> <span class="mh">0xfc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">HEADER_GC_PHASE</span>								<span class="o">=</span> <span class="mh">0xfd</span><span class="p">,</span>
</span></span></code></pre></div><p>Add above:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="n">HEADER_CG_BUY_ITEMSHOP_ITEM</span>						<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">HEADER_CG_PROMOTION</span>							<span class="o">=</span> <span class="mi">241</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><p>Search:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">		<span class="n">HEADER_GG_LOGIN</span>								<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span></span></code></pre></div><p>Add above:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>			<span class="n">HEADER_GC_ITEMSHOP</span> 						<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><p>Add to the end of file before <strong>#pragma pack()</strong>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">SPacketGCitemshopCategorySize</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="n">TPacketGCitemshopCategorySize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">SPacketGCItemshopItemSize</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="n">TPacketGCItemshopItemSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">SPacketGCItemshopInfo</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">BYTE</span> <span class="n">header</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">DWORD</span> <span class="n">subheader</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="n">TPacketGCItemshopInfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">enum</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">SUBHEADER_ITEMSHOP_REFRESH_ITEMS</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">SUBHEADER_ITEMSHOP_REFRESH_COINS</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">SUBHEADER_ITEMSHOP_REFRESH_SINGLE_ITEM</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">SUBHEADER_ITEMSHOP_REMOVE_SINGLE_ITEM</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">SUBHEADER_ITEMSHOP_ADD_SINGLE_ITEM</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="n">SUBHEADER_PROMOTION_CODE_REWARDS</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">SPacketCGBuyItemshopItem</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">BYTE</span>	<span class="n">header</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">char</span>	<span class="n">hash</span><span class="p">[</span><span class="n">ITEMSHOP_HASH_MAX_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="n">WORD</span>	<span class="n">wCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="n">TPacketCGBuyItemshopItem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">SPacketCGRedeemPromotionCode</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">BYTE</span>	<span class="n">header</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">char</span>	<span class="n">promotion_code</span><span class="p">[</span><span class="n">PROMOTION_CODE_MAX_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="n">TPacketCGRedeemPromotionCode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><hr>
<h3 id="12-packet_infocpp">12. packet_info.cpp</h3>
<p>Search:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="n">CPacketInfoCG</span><span class="o">::</span><span class="n">CPacketInfoCG</span><span class="p">()</span>
</span></span></code></pre></div><p>Add to the end of this function:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="n">Set</span><span class="p">(</span><span class="n">HEADER_CG_BUY_ITEMSHOP_ITEM</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TPacketCGBuyItemshopItem</span><span class="p">),</span> <span class="s">&#34;BuyItemshopItem&#34;</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">Set</span><span class="p">(</span><span class="n">HEADER_CG_PROMOTION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TPacketCGRedeemPromotionCode</span><span class="p">),</span> <span class="s">&#34;RedeemPromotionCode&#34;</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><hr>
<h3 id="13-makefile--solution">13. MakeFile / Solution</h3>
<p>Add:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="n">itemshop</span><span class="p">.</span><span class="n">cpp</span><span class="err">\</span><span class="p">,</span>
</span></span></code></pre></div><hr>
<h3 id="14-itemshoph">14. itemshop.h</h3>
<p>Create:
itemshop.h</p>
<p>Insert this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	  .oooooo.   oooooo   oooo ooooo      ooo   .oooo.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 d8P&#39;  `Y8b   `888.   .8&#39;  `888b.     `8&#39; .dP&#34;&#34;Y88b
</span></span></span><span class="line"><span class="cl"><span class="cm">	888            `888. .8&#39;    8 `88b.    8        ]8P&#39;
</span></span></span><span class="line"><span class="cl"><span class="cm">	888             `888.8&#39;     8   `88b.  8      &lt;88b.
</span></span></span><span class="line"><span class="cl"><span class="cm">	888              `888&#39;      8     `88b.8       `88b.
</span></span></span><span class="line"><span class="cl"><span class="cm">	`88b    ooo       888       8       `888  o.   .88P
</span></span></span><span class="line"><span class="cl"><span class="cm">	 `Y8bood8P&#39;      o888o     o8o        `8  `8bd88P&#39;
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">	Version:
</span></span></span><span class="line"><span class="cl"><span class="cm">		Release 1.0.0
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">	Contacts:
</span></span></span><span class="line"><span class="cl"><span class="cm">		Metin2Downloads: https://www.metin2downloads.to/cms/user/11018-cyn3/
</span></span></span><span class="line"><span class="cl"><span class="cm">		Discord: Franky#6315
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">	Support:
</span></span></span><span class="line"><span class="cl"><span class="cm">		Discord: https://discord.gg/sura-head
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">	Special thanks to:
</span></span></span><span class="line"><span class="cl"><span class="cm">		- Rainer &lt;- Design &amp; Animations
</span></span></span><span class="line"><span class="cl"><span class="cm">		- SamaLamaDingDong &lt;- Code review (Server - Source)
</span></span></span><span class="line"><span class="cl"><span class="cm">		- &lt;&gt; &lt;- Mental support
</span></span></span><span class="line"><span class="cl"><span class="cm">	*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cp">#include</span> <span class="cpf">&#34;../../common/singleton.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&#34;../../common/service.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&lt;unordered_map&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&#34;constants.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="k">class</span> <span class="nc">CItemshopManager</span> <span class="o">:</span> <span class="k">public</span> <span class="n">singleton</span><span class="o">&lt;</span><span class="n">CItemshopManager</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">CItemshopManager</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="o">~</span><span class="n">CItemshopManager</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kt">void</span> <span class="nf">InitializeItems</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">table</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="kt">void</span> <span class="nf">InitializeCategories</span><span class="p">(</span><span class="n">TItemshopCategoryTable</span><span class="o">*</span> <span class="n">table</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kt">void</span> <span class="nf">RefreshSingleItem</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="kt">void</span> <span class="nf">RemoveSingleItem</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="kt">void</span> <span class="nf">AddSingleItem</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kt">bool</span> <span class="nf">IsValidHash</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="kt">bool</span> <span class="nf">HasEnoughCoins</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">accID</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ullItemPrice</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="kt">bool</span> <span class="nf">IsValidPurchase</span><span class="p">(</span><span class="n">TItemshopItemTable</span> <span class="n">itemInfo</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">wCount</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">ullPrice</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="kt">bool</span> <span class="nf">CanBuyItem</span><span class="p">(</span><span class="n">LPCHARACTER</span> <span class="n">ch</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">hash</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">wCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="kt">bool</span> <span class="nf">BuyItem</span><span class="p">(</span><span class="n">LPCHARACTER</span> <span class="n">ch</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">hash</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">wCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span> <span class="o">&lt;</span><span class="n">BYTE</span><span class="p">,</span> <span class="n">TItemshopCategoryInfo</span><span class="o">&gt;</span> <span class="n">GetItemshopCategories</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span> <span class="o">&lt;</span><span class="n">BYTE</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TItemshopItemTable</span><span class="o">&gt;&gt;</span> <span class="n">GetItemshopItems</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span> <span class="o">&lt;</span><span class="n">BYTE</span><span class="p">,</span> <span class="n">TItemshopCategoryInfo</span><span class="o">&gt;</span> <span class="n">m_ItemshopCategories</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span> <span class="o">&lt;</span><span class="n">BYTE</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TItemshopItemTable</span><span class="o">&gt;&gt;</span> <span class="n">m_ItemshopItems</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><hr>
<h3 id="15-itemshopcpp">15. itemshop.cpp</h3>
<p>Create: itemshop.cpp</p>
<p>Insert this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">	<span class="cp">#include</span> <span class="cpf">&#34;stdafx.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&#34;itemshop.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">	<span class="cp">#include</span> <span class="cpf">&#34;char.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&#34;db.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&#34;char_manager.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&#34;sectree_manager.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&#34;config.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&#34;item_manager.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&#34;item.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#include</span> <span class="cpf">&#34;desc.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="cp">#ifdef ENABLE_ITEMSHOP
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="n">CItemshopManager</span><span class="o">::</span><span class="n">CItemshopManager</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">CItemshopManager</span><span class="o">::~</span><span class="n">CItemshopManager</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CItemshopManager</span><span class="o">::</span><span class="n">InitializeItems</span><span class="p">(</span><span class="n">TItemshopItemTable</span> <span class="o">*</span> <span class="n">table</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">m_ItemshopItems</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">table</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">const</span> <span class="n">TItemTable</span><span class="o">*</span> <span class="n">item_table</span> <span class="o">=</span> <span class="n">ITEM_MANAGER</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">GetTable</span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">dwVnum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">item_table</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">wCount</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">IS_SET</span><span class="p">(</span><span class="n">item_table</span><span class="o">-&gt;</span><span class="n">dwAntiFlags</span><span class="p">,</span> <span class="n">ITEM_ANTIFLAG_STACK</span><span class="p">))</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">IS_SET</span><span class="p">(</span><span class="n">item_table</span><span class="o">-&gt;</span><span class="n">dwFlags</span><span class="p">,</span> <span class="n">ITEM_FLAG_STACKABLE</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">sys_err</span><span class="p">(</span><span class="s">&#34;&lt;Itemshop / Are you stupid?&gt; Vnum %lld Count %d but item is not stackable. Adjust this shit!&#34;</span><span class="p">,</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">dwVnum</span><span class="p">,</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">wCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="n">m_ItemshopItems</span><span class="p">[</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">byCategory</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="o">*</span><span class="n">table</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CItemshopManager</span><span class="o">::</span><span class="n">InitializeCategories</span><span class="p">(</span><span class="n">TItemshopCategoryTable</span><span class="o">*</span> <span class="n">table</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">m_ItemshopCategories</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">table</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">m_ItemshopCategories</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CItemshopManager</span><span class="o">::</span><span class="n">RefreshSingleItem</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">category</span> <span class="p">:</span> <span class="n">m_ItemshopItems</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">cur_item</span> <span class="p">:</span> <span class="n">category</span><span class="p">.</span><span class="n">second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cur_item</span><span class="p">.</span><span class="n">hash</span><span class="p">,</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">thecore_memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur_item</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">					<span class="n">CHARACTER_MANAGER</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">SendItemshopSingleItemRefresh</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CItemshopManager</span><span class="o">::</span><span class="n">RemoveSingleItem</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">category</span> <span class="p">:</span> <span class="n">m_ItemshopItems</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">category</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">category</span><span class="p">.</span><span class="n">second</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hash</span><span class="p">,</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">hash</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">category</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">category</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="n">CHARACTER_MANAGER</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">SendItemshopSingleRemoveItem</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">CItemshopManager</span><span class="o">::</span><span class="n">AddSingleItem</span><span class="p">(</span><span class="n">TItemshopItemTable</span><span class="o">*</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">TItemTable</span><span class="o">*</span> <span class="n">item_table</span> <span class="o">=</span> <span class="n">ITEM_MANAGER</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">GetTable</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">dwVnum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">item_table</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">wCount</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">IS_SET</span><span class="p">(</span><span class="n">item_table</span><span class="o">-&gt;</span><span class="n">dwAntiFlags</span><span class="p">,</span> <span class="n">ITEM_ANTIFLAG_STACK</span><span class="p">))</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">IS_SET</span><span class="p">(</span><span class="n">item_table</span><span class="o">-&gt;</span><span class="n">dwFlags</span><span class="p">,</span> <span class="n">ITEM_FLAG_STACKABLE</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">sys_err</span><span class="p">(</span><span class="s">&#34;&lt;Itemshop / Are you stupid?&gt; Vnum %ld Count %d but item is not stackable. Adjust this shit!&#34;</span><span class="p">,</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">dwVnum</span><span class="p">,</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">wCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">m_ItemshopItems</span><span class="p">[</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">byCategory</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="o">*</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">CHARACTER_MANAGER</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">SendItemshopSingleAddItem</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">CItemshopManager</span><span class="o">::</span><span class="n">IsValidHash</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">category</span> <span class="p">:</span> <span class="n">m_ItemshopItems</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">category</span><span class="p">.</span><span class="n">second</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">hash</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">CItemshopManager</span><span class="o">::</span><span class="n">IsValidPurchase</span><span class="p">(</span><span class="n">TItemshopItemTable</span> <span class="n">itemInfo</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">wCount</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">&amp;</span><span class="n">ullPrice</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">TItemTable</span><span class="o">*</span> <span class="n">item_table</span> <span class="o">=</span> <span class="n">ITEM_MANAGER</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">GetTable</span><span class="p">(</span><span class="n">itemInfo</span><span class="p">.</span><span class="n">dwVnum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">item_table</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// NOTE: Log user reason custom packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="p">(</span><span class="n">wCount</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">IS_SET</span><span class="p">(</span><span class="n">item_table</span><span class="o">-&gt;</span><span class="n">dwAntiFlags</span><span class="p">,</span> <span class="n">ITEM_ANTIFLAG_STACK</span><span class="p">))</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">IS_SET</span><span class="p">(</span><span class="n">item_table</span><span class="o">-&gt;</span><span class="n">dwFlags</span><span class="p">,</span> <span class="n">ITEM_FLAG_STACKABLE</span><span class="p">))))</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">wCount</span> <span class="o">&lt;=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">			<span class="o">||</span> <span class="n">check_mul_error</span><span class="p">(</span><span class="n">itemInfo</span><span class="p">.</span><span class="n">wCount</span><span class="p">,</span> <span class="n">wCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="o">||</span> <span class="n">itemInfo</span><span class="p">.</span><span class="n">wCount</span> <span class="o">*</span> <span class="n">wCount</span> <span class="o">&gt;</span> <span class="n">MAX_ITEM_STACK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">BYTE</span> <span class="n">discountPercent</span> <span class="o">=</span> <span class="n">MINMAX</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">itemInfo</span><span class="p">.</span><span class="n">byDiscountPercent</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">discountPercent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ullPrice</span> <span class="o">=</span> <span class="n">ullPrice</span> <span class="o">-</span> <span class="p">(</span><span class="n">ullPrice</span> <span class="o">*</span> <span class="n">discountPercent</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">check_mul_error</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ullPrice</span><span class="p">,</span> <span class="n">wCount</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">ullPrice</span> <span class="o">*=</span> <span class="n">wCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">CItemshopManager</span><span class="o">::</span><span class="n">HasEnoughCoins</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">accID</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ullItemPrice</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SQLMsg</span><span class="o">&gt;</span> <span class="n">pkMsg</span><span class="p">(</span><span class="n">DBManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">DirectQuery</span><span class="p">(</span><span class="s">&#34;SELECT coins from account.account WHERE id = %ld&#34;</span><span class="p">,</span> <span class="n">accID</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="n">SQLResult</span><span class="o">*</span> <span class="n">pRes</span> <span class="o">=</span> <span class="n">pkMsg</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">pRes</span><span class="o">-&gt;</span><span class="n">uiNumRows</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">MYSQL_ROW</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mysql_fetch_row</span><span class="p">(</span><span class="n">pRes</span><span class="o">-&gt;</span><span class="n">pSQLResult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ullTotalCoins</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">str_to_number</span><span class="p">(</span><span class="n">ullTotalCoins</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">ullTotalCoins</span> <span class="o">&gt;=</span> <span class="n">ullItemPrice</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">CItemshopManager</span><span class="o">::</span><span class="n">CanBuyItem</span><span class="p">(</span><span class="n">LPCHARACTER</span> <span class="n">ch</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">hash</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">wCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">CanUseItemshop</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ChatPacket</span><span class="p">(</span><span class="n">CHAT_TYPE_INFO</span><span class="p">,</span> <span class="n">LC_TEXT</span><span class="p">(</span><span class="s">&#34;You have to wait 10 seconds after an invalid itemshop action.&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsValidHash</span><span class="p">(</span><span class="n">hash</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">SetItemshopCooldown</span><span class="p">(</span><span class="n">thecore_pulse</span><span class="p">()</span> <span class="o">+</span> <span class="n">PASSES_PER_SEC</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">TItemshopItemTable</span> <span class="n">itemInfo</span><span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">category</span> <span class="p">:</span> <span class="n">m_ItemshopItems</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">category</span><span class="p">.</span><span class="n">second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">hash</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">itemInfo</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">					<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">itemInfo</span><span class="p">.</span><span class="n">llLimitCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ullPrice</span> <span class="o">=</span> <span class="n">itemInfo</span><span class="p">.</span><span class="n">ullPrice</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsValidPurchase</span><span class="p">(</span><span class="n">itemInfo</span><span class="p">,</span> <span class="n">wCount</span><span class="p">,</span> <span class="n">ullPrice</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">sys_err</span><span class="p">(</span><span class="s">&#34;&lt;Itemshop&gt; OVERFLOW check failed. PID: %d - BuyCount %d - Hash %s - Vnum %lld - Count %d&#34;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">GetPlayerID</span><span class="p">(),</span> <span class="n">wCount</span><span class="p">,</span> <span class="n">itemInfo</span><span class="p">.</span><span class="n">hash</span><span class="p">,</span> <span class="n">itemInfo</span><span class="p">.</span><span class="n">dwVnum</span><span class="p">,</span> <span class="n">itemInfo</span><span class="p">.</span><span class="n">wCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">TAccountTable</span><span class="o">&amp;</span> <span class="n">accTable</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">GetDesc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetAccountTable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HasEnoughCoins</span><span class="p">(</span><span class="n">accTable</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ullPrice</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">SetItemshopCooldown</span><span class="p">(</span><span class="n">thecore_pulse</span><span class="p">()</span> <span class="o">+</span> <span class="n">PASSES_PER_SEC</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ChatPacket</span><span class="p">(</span><span class="n">CHAT_TYPE_INFO</span><span class="p">,</span> <span class="n">LC_TEXT</span><span class="p">(</span><span class="s">&#34;You dont have enough coins.&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LPITEM</span> <span class="n">item</span> <span class="o">=</span> <span class="n">ITEM_MANAGER</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">CreateItem</span><span class="p">(</span><span class="n">itemInfo</span><span class="p">.</span><span class="n">dwVnum</span><span class="p">,</span> <span class="n">itemInfo</span><span class="p">.</span><span class="n">wCount</span> <span class="o">*</span> <span class="n">wCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ChatPacket</span><span class="p">(</span><span class="n">CHAT_TYPE_INFO</span><span class="p">,</span> <span class="n">LC_TEXT</span><span class="p">(</span><span class="s">&#34;Invalid item -&gt; Write your Serveradmin to get some free coins :)&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">iEmptyCell</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">IsDragonSoul</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">((</span><span class="n">iEmptyCell</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">GetEmptyDragonSoulInventory</span><span class="p">(</span><span class="n">item</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ChatPacket</span><span class="p">(</span><span class="n">CHAT_TYPE_INFO</span><span class="p">,</span> <span class="n">LC_TEXT</span><span class="p">(</span><span class="s">&#34;You carry too many Items.&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">				<span class="n">M2_DESTROY_ITEM</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// NOTE: Adjust for special inventory by sanii
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="p">((</span><span class="n">iEmptyCell</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">GetEmptyInventory</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">GetSize</span><span class="p">()))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ChatPacket</span><span class="p">(</span><span class="n">CHAT_TYPE_INFO</span><span class="p">,</span> <span class="n">LC_TEXT</span><span class="p">(</span><span class="s">&#34;You carry too many Items.&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">				<span class="n">M2_DESTROY_ITEM</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">M2_DESTROY_ITEM</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// NOTE: CALL THIS ONLY FROM DB_MANAGER
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">bool</span> <span class="n">CItemshopManager</span><span class="o">::</span><span class="n">BuyItem</span><span class="p">(</span><span class="n">LPCHARACTER</span> <span class="n">ch</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">hash</span><span class="p">,</span> <span class="n">WORD</span> <span class="n">wCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsValidHash</span><span class="p">(</span><span class="n">hash</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">SendItemshopItemsPacket</span><span class="p">(</span><span class="n">GetItemshopItems</span><span class="p">(),</span><span class="n">GetItemshopCategories</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">TItemshopItemTable</span> <span class="n">itemInfo</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">category</span> <span class="p">:</span> <span class="n">m_ItemshopItems</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span> <span class="nl">item</span> <span class="p">:</span> <span class="n">category</span><span class="p">.</span><span class="n">second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">hash</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">itemInfo</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">					<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ullPrice</span> <span class="o">=</span> <span class="n">itemInfo</span><span class="p">.</span><span class="n">ullPrice</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IsValidPurchase</span><span class="p">(</span><span class="n">itemInfo</span><span class="p">,</span> <span class="n">wCount</span><span class="p">,</span> <span class="n">ullPrice</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">sys_err</span><span class="p">(</span><span class="s">&#34;&lt;Itemshop&gt; OVERFLOW check failed. PID: %d - BuyCount %d - Hash %s - Vnum %lld - Count %d&#34;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">GetPlayerID</span><span class="p">(),</span> <span class="n">wCount</span><span class="p">,</span> <span class="n">itemInfo</span><span class="p">.</span><span class="n">hash</span><span class="p">,</span> <span class="n">itemInfo</span><span class="p">.</span><span class="n">dwVnum</span><span class="p">,</span> <span class="n">itemInfo</span><span class="p">.</span><span class="n">wCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="n">TAccountTable</span><span class="o">&amp;</span> <span class="n">accTable</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">GetDesc</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetAccountTable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HasEnoughCoins</span><span class="p">(</span><span class="n">accTable</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ullPrice</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ChatPacket</span><span class="p">(</span><span class="n">CHAT_TYPE_INFO</span><span class="p">,</span> <span class="n">LC_TEXT</span><span class="p">(</span><span class="s">&#34;You dont have enough coins.&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">LPITEM</span> <span class="n">item</span> <span class="o">=</span> <span class="n">ITEM_MANAGER</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">CreateItem</span><span class="p">(</span><span class="n">itemInfo</span><span class="p">.</span><span class="n">dwVnum</span><span class="p">,</span> <span class="n">itemInfo</span><span class="p">.</span><span class="n">wCount</span> <span class="o">*</span> <span class="n">wCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ChatPacket</span><span class="p">(</span><span class="n">CHAT_TYPE_INFO</span><span class="p">,</span> <span class="n">LC_TEXT</span><span class="p">(</span><span class="s">&#34;Invalid item -&gt; Write your Serveradmin to get some free coins :)&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// NOTE: adjust as needed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="kt">bool</span> <span class="n">forcedSockets</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">itemInfo</span><span class="p">.</span><span class="n">alSockets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ITEM_LIMIT_MAX_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="n">LIMIT_REAL_TIME</span> <span class="o">==</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">GetLimitType</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// NOTE: We set socket0 as time value, but only if socket is set so we still can use default times in createitem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">item</span><span class="o">-&gt;</span><span class="n">SetSocket</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">itemInfo</span><span class="p">.</span><span class="n">alSockets</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">					<span class="c1">// NOTE: We dont have to start realtime event because createitem already does
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="n">forcedSockets</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">LIMIT_TIMER_BASED_ON_WEAR</span> <span class="o">==</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">GetLimitType</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="n">item</span><span class="o">-&gt;</span><span class="n">SetSocket</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">itemInfo</span><span class="p">.</span><span class="n">alSockets</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">					<span class="n">forcedSockets</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// NOTE: I dont have systems where i need to set multiple sockets in createitem but you can still do:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// for(const auto&amp; socket : itemInfo.alSockets)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">forcedSockets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">item</span><span class="o">-&gt;</span><span class="n">SetSockets</span><span class="p">(</span><span class="n">itemInfo</span><span class="p">.</span><span class="n">alSockets</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// NOTE: You can adjust this if you want to use bAlterToMagicItemPct
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">item</span><span class="o">-&gt;</span><span class="n">SetAttributes</span><span class="p">(</span><span class="n">itemInfo</span><span class="p">.</span><span class="n">aAttr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">iEmptyCell</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">IsDragonSoul</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">((</span><span class="n">iEmptyCell</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">GetEmptyDragonSoulInventory</span><span class="p">(</span><span class="n">item</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ChatPacket</span><span class="p">(</span><span class="n">CHAT_TYPE_INFO</span><span class="p">,</span> <span class="n">LC_TEXT</span><span class="p">(</span><span class="s">&#34;You carry too many Items.&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">				<span class="n">M2_DESTROY_ITEM</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// NOTE: Adjust for special inventory by sanii
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="p">((</span><span class="n">iEmptyCell</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">GetEmptyInventory</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">GetSize</span><span class="p">()))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ChatPacket</span><span class="p">(</span><span class="n">CHAT_TYPE_INFO</span><span class="p">,</span> <span class="n">LC_TEXT</span><span class="p">(</span><span class="s">&#34;You carry too many Items.&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">				<span class="n">M2_DESTROY_ITEM</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">DBManager</span><span class="o">::</span><span class="n">instance</span><span class="p">().</span><span class="n">DirectQuery</span><span class="p">(</span><span class="s">&#34;UPDATE account.account SET coins = coins - %lld WHERE id = %ld&#34;</span><span class="p">,</span> <span class="n">ullPrice</span><span class="p">,</span> <span class="n">accTable</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">IsDragonSoul</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="n">item</span><span class="o">-&gt;</span><span class="n">AddToCharacter</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">TItemPos</span><span class="p">(</span><span class="n">DRAGON_SOUL_INVENTORY</span><span class="p">,</span> <span class="n">iEmptyCell</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="n">item</span><span class="o">-&gt;</span><span class="n">AddToCharacter</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">TItemPos</span><span class="p">(</span><span class="n">INVENTORY</span><span class="p">,</span> <span class="n">iEmptyCell</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">ChatPacket</span><span class="p">(</span><span class="n">CHAT_TYPE_INFO</span><span class="p">,</span> <span class="n">LC_TEXT</span><span class="p">(</span><span class="s">&#34;The purchase of the item was successful.&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">SendItemshopCoinPacket</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span> <span class="o">&lt;</span><span class="n">BYTE</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TItemshopItemTable</span><span class="o">&gt;&gt;</span> <span class="n">CItemshopManager</span><span class="o">::</span><span class="n">GetItemshopItems</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">m_ItemshopItems</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span> <span class="o">&lt;</span> <span class="n">BYTE</span><span class="p">,</span> <span class="n">TItemshopCategoryInfo</span><span class="o">&gt;</span> <span class="n">CItemshopManager</span><span class="o">::</span><span class="n">GetItemshopCategories</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">m_ItemshopCategories</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="cp">#endif
</span></span></span></code></pre></div><hr>

            <footer class="footline">
            </footer>
          </article>
        </div>
      </main>
    </div>
    <aside id="sidebar" class="default-animation">
      <div id="header-wrapper" class="default-animation">
        <div id="header" class="default-animation">
<a href="../../../../../index.html"><h4>sura-head</h4></a>
        </div>
        <div class="searchbox default-animation">
          <label for="search-by"><i class="fas fa-search"></i></label>
          <input data-search-input id="search-by" type="search" placeholder="Search...">
          <span data-search-clear=""><i class="fas fa-times"></i></span>
        </div>
        <script>
          var contentLangs=['en'];
        </script>
        <script src="../../../../../js/auto-complete8069.js?1670088480" defer></script>
        <script src="../../../../../js/lunr.min8069.js?1670088480" defer></script>
        <script src="../../../../../js/lunr.stemmer.support.min8069.js?1670088480" defer></script>
        <script src="../../../../../js/lunr.multi.min8069.js?1670088480" defer></script>
        <script src="../../../../../js/lunr.en.min8069.js?1670088480" defer></script>
        <script src="../../../../../js/search8069.js?1670088480" defer></script>
      </div>
      <div id="homelinks" class="default-animation">
        <ul>
          <li>
              <a class="padding" href="../../../../../index.html"><i class="fas fa-home"></i> Home</a>
          </li>
        </ul>
      </div>
      <div id="content-wrapper" class="highlightable">
        <ul class="topics collapsible-menu">
          <li data-nav-id="/serverfiles/" title="Serverfiles" class="dd-item"><a href="../../../../../serverfiles/index.html">Serverfiles</a></li>
          <li data-nav-id="/installation/" title="Installation" class="dd-item"><input type="checkbox" id="section-07cca5796d23f5bae96340e1eaa52bc5" class="toggle"/><label for="section-07cca5796d23f5bae96340e1eaa52bc5" ></label><a href="../../../../../installation/index.html">Installation</a><ul>
          <li data-nav-id="/installation/freebsd/" title="FreeBSD" class="dd-item"><a href="../../../../../installation/freebsd/index.html">FreeBSD</a></li>
          <li data-nav-id="/installation/ssh/" title="SSH" class="dd-item"><a href="../../../../../installation/ssh/index.html">SSH</a></li>
          <li data-nav-id="/installation/mysql/" title="MySQL" class="dd-item"><a href="../../../../../installation/mysql/index.html">MySQL</a></li>
          <li data-nav-id="/installation/netdata/" title="Netdata" class="dd-item"><a href="../../../../../installation/netdata/index.html">Netdata</a></li></ul></li>
          <li data-nav-id="/systems/" title="Systems" class="dd-item parent"><input type="checkbox" id="section-8032065834bbbd2a3e51cab841014698" class="toggle" checked/><label for="section-8032065834bbbd2a3e51cab841014698" ></label><a href="../../../../index.html">Systems</a><ul>
          <li data-nav-id="/systems/itemshop/" title="Itemshop" class="dd-item parent"><input type="checkbox" id="section-bbb7ab6baa853f143816058e1337ac6e" class="toggle" checked/><label for="section-bbb7ab6baa853f143816058e1337ac6e" ></label><a href="../../../index.html">Itemshop</a><ul>
          <li data-nav-id="/systems/itemshop/installation/" title="Installation" class="dd-item parent"><input type="checkbox" id="section-b371428a3419ef49c362d7ae7d67ec4c" class="toggle" checked/><label for="section-b371428a3419ef49c362d7ae7d67ec4c" ></label><a href="../../index.html">Installation</a><ul>
          <li data-nav-id="/systems/itemshop/installation/server/" title="Server" class="dd-item parent"><input type="checkbox" id="section-970d61e88b8846bf1033cf2b67d8d6b0" class="toggle" checked/><label for="section-970d61e88b8846bf1033cf2b67d8d6b0" ></label><a href="../index.html">Server</a><ul>
          <li data-nav-id="/systems/itemshop/installation/server/common/" title="Common" class="dd-item"><a href="../common/index.html">Common</a></li>
          <li data-nav-id="/systems/itemshop/installation/server/db/" title="DB" class="dd-item"><a href="../db/index.html">DB</a></li>
          <li data-nav-id="/systems/itemshop/installation/server/game/" title="Game" class="dd-item active"><a href="index.html">Game</a></li>
          <li data-nav-id="/systems/itemshop/installation/server/database/" title="Database" class="dd-item"><a href="../database/index.html">Database</a></li></ul></li>
          <li data-nav-id="/systems/itemshop/installation/binary/" title="Binary" class="dd-item"><input type="checkbox" id="section-40904d5245286687a253a77be5db0ea7" class="toggle"/><label for="section-40904d5245286687a253a77be5db0ea7" ></label><a href="../../binary/index.html">Binary</a><ul>
          <li data-nav-id="/systems/itemshop/installation/binary/eterpythonlib/" title="EterPythonLib" class="dd-item"><a href="../../binary/eterpythonlib/index.html">EterPythonLib</a></li>
          <li data-nav-id="/systems/itemshop/installation/binary/userinterface/" title="UserInterface" class="dd-item"><a href="../../binary/userinterface/index.html">UserInterface</a></li>
          <li data-nav-id="/systems/itemshop/installation/binary/client/" title="Client" class="dd-item"><a href="../../binary/client/index.html">Client</a></li></ul></li></ul></li>
          <li data-nav-id="/systems/itemshop/errors/" title="Possible errors and fixes" class="dd-item"><a href="../../../errors/index.html">Possible errors and fixes</a></li>
          <li data-nav-id="/systems/itemshop/guides/" title="Guides" class="dd-item"><a href="../../../guides/index.html">Guides</a></li>
          <li data-nav-id="/systems/itemshop/howto/" title="HowTo Addons" class="dd-item"><a href="../../../howto/index.html">HowTo Addons</a></li>
          <li data-nav-id="/systems/itemshop/mysql/" title="Mysql-Tables" class="dd-item"><a href="../../../mysql/index.html">Mysql-Tables</a></li></ul></li></ul></li>
          <li data-nav-id="/fixes/" title="Fixes" class="dd-item"><input type="checkbox" id="section-abc5759ee155c22affa71e4aa9f79a1a" class="toggle"/><label for="section-abc5759ee155c22affa71e4aa9f79a1a" ></label><a href="../../../../../fixes/index.html">Fixes</a><ul>
          <li data-nav-id="/fixes/invalid_player_id/" title="DoS vulnerability (invalid player id spam)" class="dd-item"><a href="../../../../../fixes/invalid_player_id/index.html">DoS vulnerability (invalid player id spam)</a></li>
          <li data-nav-id="/fixes/sectree_memory/" title="SecTree Memory adjustment" class="dd-item"><a href="../../../../../fixes/sectree_memory/index.html">SecTree Memory adjustment</a></li>
          <li data-nav-id="/fixes/collsion_rendering/" title="Collision rendering" class="dd-item"><a href="../../../../../fixes/collsion_rendering/index.html">Collision rendering</a></li></ul></li>
        </ul>
        <div class="footermargin footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"></div>
        <hr class="default-animation footerLangSwitch footerVariantSwitch footerVisitedLinks footerFooter showFooter"/>
        <div id="prefooter" class="footerLangSwitch footerVariantSwitch footerVisitedLinks">
          <ul>
            <li id="select-language-container" class="footerLangSwitch">
              <a class="padding select-container">
                <i class="fas fa-language fa-fw"></i>
                <span>&nbsp;</span>
                <div class="select-style">
                  <select id="select-language" onchange="location = baseUri + this.value;">
                  </select>
                </div>
                <div class="select-clear"></div>
              </a>
            </li>
            <li id="select-variant-container" class="footerVariantSwitch">
              <a class="padding select-container">
                <i class="fas fa-paint-brush fa-fw"></i>
                <span>&nbsp;</span>
                <div class="select-style">
                  <select id="select-variant" onchange="window.variants && variants.changeVariant( this.value );">
                    <option id="blue" value="blue" selected>Blue</option>
                  </select>
                </div>
                <div class="select-clear"></div>
              </a>
              <script>window.variants && variants.markSelectedVariant();</script>
            </li>
            <li class="footerVisitedLinks"><a class="padding" onclick="clearHistory();"><i class="fas fa-history fa-fw"></i> Clear History</a></li>
          </ul>
        </div>
        <div id="footer" class="footerFooter showFooter"><center>
    <a href="https://discord.gg/sura-head"><i class="fas fa-heart"></i>Join our discord</a>
</center>
        </div>
      </div>
    </aside>
    <script src="../../../../../js/clipboard.min8069.js?1670088480" defer></script>
    <script src="../../../../../js/perfect-scrollbar.min8069.js?1670088480" defer></script>
    <script src="../../../../../js/featherlight.min8069.js?1670088480" defer></script>
    <script src="../../../../../js/theme8069.js?1670088480" defer></script>
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vaafb692b2aea4879b33c060e79fe94621666317369993" integrity="sha512-0ahDYl866UMhKuYcW078ScMalXqtFJggm7TmlUtp0UlD4eQk0Ixfnm5ykXKvGJNFjLMoortdseTfsRT8oCfgGA==" data-cf-beacon='{"rayId":"773e2239f90e99d5","version":"2022.11.3","r":1,"token":"a7c91de8d0ad498fbb5c0483e3f90c9c","si":100}' crossorigin="anonymous"></script>
</body>

<!-- Mirrored from docs.sura-head.dev/systems/itemshop/installation/server/game/ by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 03 Dec 2022 17:48:54 GMT -->
</html>
